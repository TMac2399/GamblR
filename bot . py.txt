import discord
from discord.ext import commands, tasks
import random
import sqlite3
import datetime

TOKEN = import os
TOKEN = os.getenv("TOKEN")


intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# DATABASE
conn = sqlite3.connect("data.db")
c = conn.cursor()
c.execute("""
CREATE TABLE IF NOT EXISTS results (
    id INTEGER PRIMARY KEY,
    result TEXT,
    date TEXT
)
""")
conn.commit()

@bot.event
async def on_ready():
    print("Top GamblR is online")
    post_racing_tips.start()

def generate_tip():
    selection = random.randint(1, 8)
    odds = round(random.uniform(2.0, 4.5), 2)
    confidence = random.randint(68, 85)
    return selection, odds, confidence

@tasks.loop(hours=3)
async def post_racing_tips():
    guild = bot.guilds[0]
    horse = discord.utils.get(guild.text_channels, name="horse-racing-ai")
    dog = discord.utils.get(guild.text_channels, name="greyhound-racing-ai")

    s, o, c = generate_tip()
    await horse.send(
        f"üèá **Horse Racing AI**\n"
        f"Selection: #{s}\nOdds: {o}\nConfidence: {c}%"
    )

    s, o, c = generate_tip()
    await dog.send(
        f"üêï **Greyhound Racing AI**\n"
        f"Selection: Box {s}\nOdds: {o}\nConfidence: {c}%"
    )

@bot.slash_command(name="hedge", description="Hedge bet calculator")
async def hedge(ctx, stake: float, odds1: float, odds2: float):
    hedge_stake = (stake * odds1) / odds2
    profit = hedge_stake * odds2 - (stake + hedge_stake)
    await ctx.respond(
        f"üí∞ Hedge Result\n"
        f"Hedge Stake: ${hedge_stake:.2f}\n"
        f"Guaranteed Profit: ${profit:.2f}"
    )

@bot.slash_command(name="last5", description="Last 5 results")
async def last5(ctx):
    c.execute("SELECT result FROM results ORDER BY id DESC LIMIT 5")
    rows = c.fetchall()
    results = " | ".join([r[0] for r in rows])
    await ctx.respond(f"üìä Last 5 Results:\n{results}")

bot.run(TOKEN)

